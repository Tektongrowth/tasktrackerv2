generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  admin
  contractor
}

enum AccessLevel {
  viewer // View only - no modifications
  editor // Edit existing data, no creating new
  project_manager // Create/edit all data, no admin pages
  admin // Full access including admin pages
}

enum PlanType {
  package_one
  package_two
  package_three
  package_four
  facebook_ads_addon
  custom_website_addon
}

enum SubscriptionStatus {
  active
  canceled
  past_due
}

enum TaskStatus {
  todo
  in_review
  completed
}

enum TaskPriority {
  low
  medium
  high
  urgent
}

enum TemplateType {
  onboarding
  recurring
  custom
}

enum TriggerType {
  manual // Manually triggered
  new_project // When a new project is created
  subscription_change // When subscription status changes
  schedule // Recurring schedule (cron-like)
  offboard // When a project is offboarded
}

enum SourceTier {
  tier_1
  tier_2
  tier_3
}

enum SeoDigestStatus {
  pending
  fetching
  analyzing
  generating
  delivering
  completed
  failed
}

enum SeoRecommendationStatus {
  draft
  approved
  rejected
  actioned
}

enum SeoTaskDraftStatus {
  pending
  approved
  rejected
}

model TemplateSet {
  id              String      @id @default(uuid())
  name            String
  description     String?
  triggerType     TriggerType @default(manual) @map("trigger_type")
  triggerRules    Json        @default("{}") @map("trigger_rules")
  planTypes       PlanType[]  @map("plan_types")
  active          Boolean     @default(true)
  isSystem        Boolean     @default(false) @map("is_system")
  strategyDocUrl  String?     @map("strategy_doc_url")
  createdAt       DateTime    @default(now()) @map("created_at")
  updatedAt       DateTime    @updatedAt @map("updated_at")

  templates    TaskTemplate[]
  seoSopDrafts SeoSopDraft[]

  @@map("template_sets")
}

model User {
  id                      String      @id @default(uuid())
  email                   String      @unique
  name                    String
  avatarUrl               String?     @map("avatar_url")
  googleId                String?     @unique @map("google_id")
  role                    UserRole    @default(contractor)
  accessLevel             AccessLevel @default(viewer) @map("access_level")
  permissions             Json        @default("{}")
  notificationPreferences Json        @default("{}") @map("notification_preferences")
  active                  Boolean     @default(true)
  archived                Boolean     @default(false)
  archivedAt              DateTime?   @map("archived_at")
  inviteToken             String?     @unique @map("invite_token")
  hasSeenWelcome          Boolean     @default(false) @map("has_seen_welcome")
  jobRoleId               String?     @map("job_role_id")
  telegramChatId          String?     @map("telegram_chat_id")
  telegramLinkedAt        DateTime?   @map("telegram_linked_at")
  createdAt               DateTime    @default(now()) @map("created_at")
  updatedAt               DateTime    @updatedAt @map("updated_at")

  jobRole          Role?             @relation(fields: [jobRoleId], references: [id], onDelete: SetNull)
  taskAssignments  TaskAssignee[]
  timeEntries      TimeEntry[]
  comments         TaskComment[]
  projectAccess    ProjectAccess[]
  mentions         CommentMention[]
  auditLogs        AuditLog[]
  guideCompletions GuideCompletion[]
  chatsCreated     Chat[]            @relation("ChatCreator")
  chatParticipants ChatParticipant[]
  chatMessages     ChatMessage[]
  chatReadReceipts ChatReadReceipt[]
  taskActivities           TaskActivity[]
  telegramMessagesReceived TelegramMessageMap[] @relation("TelegramRecipient")
  telegramMessagesFrom     TelegramMessageMap[] @relation("TelegramReplyTo")
  commentReactions         CommentReaction[]    @relation("CommentReactions")
  messageReactions         MessageReaction[]    @relation("MessageReactions")
  pushSubscriptions        PushSubscription[]
  taskWatching             TaskWatcher[]

  @@index([jobRoleId])
  @@map("users")
}

// Granular project access for contractors
model ProjectAccess {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  projectId String   @map("project_id")
  canView   Boolean  @default(true) @map("can_view")
  canEdit   Boolean  @default(false) @map("can_edit")
  canDelete Boolean  @default(false) @map("can_delete")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([userId, projectId])
  @@index([userId])
  @@index([projectId])
  @@map("project_access")
}

model Client {
  id               String   @id @default(uuid())
  name             String
  email            String?
  phone            String?
  stripeCustomerId String?  @unique @map("stripe_customer_id")
  embedToken       String?  @unique @map("embed_token")
  ghlLocationId    String?  @unique @map("ghl_location_id")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  projects        Project[]
  accessTokens    ClientAccessToken[]
  viewers         ClientViewer[]
  taskSubmissions TaskSubmission[]
  seoInsights     SeoClientInsight[]

  gbpLocationId       String?  @map("gbp_location_id")
  googleAdsCustomerId String?  @map("google_ads_customer_id")

  // Business details (for Drive folder automation + Cosmo Sheet pre-fill)
  contactName     String?  @map("contact_name")
  address         String?
  city            String?
  state           String?
  zip             String?
  websiteUrl      String?  @map("website_url")
  serviceArea     String?  @map("service_area")
  primaryServices String[] @default([]) @map("primary_services")

  @@map("clients")
}

model Project {
  id                   String             @id @default(uuid())
  clientId             String             @map("client_id")
  name                 String
  planType             PlanType?          @map("plan_type")
  addOns               PlanType[]         @default([]) @map("add_ons")
  stripeSubscriptionId String?            @unique @map("stripe_subscription_id")
  subscriptionStatus   SubscriptionStatus @default(active) @map("subscription_status")
  billingDate          DateTime?          @map("billing_date")
  driveFolderUrl       String?            @map("drive_folder_url")
  cosmoSheetUrl        String?            @map("cosmo_sheet_url")
  createdAt            DateTime           @default(now()) @map("created_at")
  updatedAt            DateTime           @updatedAt @map("updated_at")

  client          Client           @relation(fields: [clientId], references: [id], onDelete: Cascade)
  tasks           Task[]
  timeEntries     TimeEntry[]
  projectAccess   ProjectAccess[]
  taskSubmissions TaskSubmission[]

  @@index([clientId])
  @@map("projects")
}

model Task {
  id          String       @id @default(uuid())
  projectId   String       @map("project_id")
  templateId  String?      @map("template_id")
  title       String
  description String?
  status      TaskStatus   @default(todo)
  priority    TaskPriority @default(medium)
  dueDate     DateTime?    @map("due_date")
  tags        String[]     @default([])
  roleId      String?      @map("role_id")
  sopUrl      String?      @map("sop_url")
  sortOrder   Int          @default(0) @map("sort_order")
  archived    Boolean      @default(false)
  archivedAt  DateTime?    @map("archived_at")
  completedAt DateTime?    @map("completed_at")
  createdAt   DateTime     @default(now()) @map("created_at")
  updatedAt   DateTime     @updatedAt @map("updated_at")

  project      Project         @relation(fields: [projectId], references: [id], onDelete: Cascade)
  template     TaskTemplate?   @relation(fields: [templateId], references: [id], onDelete: SetNull)
  assignedRole Role?           @relation(fields: [roleId], references: [id], onDelete: SetNull)
  assignees    TaskAssignee[]
  timeEntries  TimeEntry[]
  activities   TaskActivity[]
  subtasks     Subtask[]
  comments     TaskComment[]
  watchers     TaskWatcher[]
  submission       TaskSubmission?
  telegramMessages TelegramMessageMap[]
  seoTaskDraft     SeoTaskDraft?

  @@index([projectId])
  @@index([status])
  @@index([dueDate])
  @@index([roleId])
  @@map("tasks")
}

model TaskAssignee {
  id         String   @id @default(uuid())
  taskId     String   @map("task_id")
  userId     String   @map("user_id")
  assignedAt DateTime @default(now()) @map("assigned_at")

  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([taskId, userId])
  @@index([taskId])
  @@index([userId])
  @@map("task_assignees")
}

model TaskTemplate {
  id                    String       @id @default(uuid())
  title                 String
  description           String?
  templateType          TemplateType @map("template_type")
  templateSetId         String?      @map("template_set_id")
  planTypes             PlanType[]   @map("plan_types")
  defaultAssigneeEmails String[]     @default([]) @map("default_assignee_emails")
  defaultRoleId         String?      @map("default_role_id")
  dueInDays             Int?         @map("due_in_days")
  tags                  String[]     @default([])
  sopUrl                String?      @map("sop_url")
  sortOrder             Int          @default(0) @map("sort_order")
  createdAt             DateTime     @default(now()) @map("created_at")
  updatedAt             DateTime     @updatedAt @map("updated_at")

  tasks       Task[]
  templateSet TemplateSet?      @relation(fields: [templateSetId], references: [id], onDelete: SetNull)
  defaultRole Role?             @relation(fields: [defaultRoleId], references: [id], onDelete: SetNull)
  subtasks    TemplateSubtask[]

  @@index([templateSetId])
  @@index([defaultRoleId])
  @@map("task_templates")
}

model TemplateSubtask {
  id         String   @id @default(uuid())
  templateId String   @map("template_id")
  title      String
  sopUrl     String?  @map("sop_url")
  sortOrder  Int      @default(0) @map("sort_order")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  template TaskTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@index([templateId])
  @@map("template_subtasks")
}

model TimeEntry {
  id              String    @id @default(uuid())
  userId          String    @map("user_id")
  taskId          String?   @map("task_id")
  projectId       String?   @map("project_id")
  title           String
  description     String?
  startTime       DateTime? @map("start_time")
  endTime         DateTime? @map("end_time")
  durationMinutes Int?      @map("duration_minutes")
  isManual        Boolean   @default(false) @map("is_manual")
  isRunning       Boolean   @default(false) @map("is_running")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  task    Task?    @relation(fields: [taskId], references: [id], onDelete: SetNull)
  project Project? @relation(fields: [projectId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([taskId])
  @@index([projectId])
  @@map("time_entries")
}

model TaskActivity {
  id        String   @id @default(uuid())
  taskId    String   @map("task_id")
  userId    String?  @map("user_id")
  action    String
  details   Json?
  createdAt DateTime @default(now()) @map("created_at")

  task Task  @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([taskId])
  @@index([userId])
  @@map("task_activities")
}

model Subtask {
  id          String    @id @default(uuid())
  taskId      String    @map("task_id")
  title       String
  sopUrl      String?   @map("sop_url")
  completed   Boolean   @default(false)
  completedAt DateTime? @map("completed_at")
  sortOrder   Int       @default(0) @map("sort_order")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@index([taskId])
  @@map("subtasks")
}

model TaskComment {
  id        String   @id @default(uuid())
  taskId    String   @map("task_id")
  userId    String?  @map("user_id")
  userName  String   @map("user_name") @default("")
  content   String
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  task        Task                 @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user        User?                @relation(fields: [userId], references: [id], onDelete: SetNull)
  mentions    CommentMention[]
  attachments CommentAttachment[]
  reactions   CommentReaction[]

  @@index([taskId])
  @@map("task_comments")
}

model CommentMention {
  id        String    @id @default(uuid())
  commentId String    @map("comment_id")
  userId    String    @map("user_id")
  notified  Boolean   @default(false)
  readAt    DateTime? @map("read_at")
  createdAt DateTime  @default(now()) @map("created_at")

  comment TaskComment @relation(fields: [commentId], references: [id], onDelete: Cascade)
  user    User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([commentId, userId])
  @@index([userId])
  @@map("comment_mentions")
}

model CommentAttachment {
  id         String   @id @default(uuid())
  commentId  String   @map("comment_id")
  fileName   String   @map("file_name")
  fileSize   Int      @map("file_size")
  fileType   String   @map("file_type")
  storageKey String   @map("storage_key")
  createdAt  DateTime @default(now()) @map("created_at")

  comment TaskComment @relation(fields: [commentId], references: [id], onDelete: Cascade)

  @@index([commentId])
  @@map("comment_attachments")
}

model CommentReaction {
  id        String   @id @default(uuid())
  commentId String   @map("comment_id")
  userId    String   @map("user_id")
  emoji     String
  createdAt DateTime @default(now()) @map("created_at")

  comment TaskComment @relation(fields: [commentId], references: [id], onDelete: Cascade)
  user    User        @relation("CommentReactions", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([commentId, userId, emoji])
  @@index([commentId])
  @@map("comment_reactions")
}

model MessageReaction {
  id        String   @id @default(uuid())
  messageId String   @map("message_id")
  userId    String   @map("user_id")
  emoji     String
  createdAt DateTime @default(now()) @map("created_at")

  message ChatMessage @relation(fields: [messageId], references: [id], onDelete: Cascade)
  user    User        @relation("MessageReactions", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([messageId, userId, emoji])
  @@index([messageId])
  @@map("message_reactions")
}

model Tag {
  id        String   @id @default(uuid())
  name      String   @unique
  color     String
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("tags")
}

model Role {
  id          String   @id @default(uuid())
  name        String   @unique
  color       String
  description String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  users     User[]
  tasks     Task[]
  templates TaskTemplate[]

  @@map("roles")
}

model Settings {
  id                   String   @id @default(uuid())
  stripeWebhookSecret  String?  @map("stripe_webhook_secret")
  emailNotifications   Boolean  @default(true) @map("email_notifications")
  notificationSettings Json     @default("{}") @map("notification_settings")
  createdAt            DateTime @default(now()) @map("created_at")
  updatedAt            DateTime @updatedAt @map("updated_at")

  @@map("settings")
}

model ClientAccessToken {
  id        String    @id @default(uuid())
  clientId  String    @map("client_id")
  token     String    @unique
  expiresAt DateTime  @map("expires_at")
  usedAt    DateTime? @map("used_at")
  createdAt DateTime  @default(now()) @map("created_at")

  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@map("client_access_tokens")
}

model ClientViewer {
  id       String   @id @default(uuid())
  clientId String   @map("client_id")
  email    String
  name     String?
  addedAt  DateTime @default(now()) @map("added_at")

  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@unique([clientId, email])
  @@map("client_viewers")
}

// Global audit logging
model AuditLog {
  id         String   @id @default(uuid())
  userId     String?  @map("user_id")
  action     String
  entityType String   @map("entity_type")
  entityIds  String[] @map("entity_ids")
  details    Json?
  ipAddress  String?  @map("ip_address")
  createdAt  DateTime @default(now()) @map("created_at")

  user User? @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([action])
  @@index([entityType])
  @@index([createdAt])
  @@map("audit_logs")
}

// Track scheduled job executions
model ScheduledJobRun {
  id          String    @id @default(uuid())
  jobName     String    @map("job_name")
  status      String
  details     Json?
  startedAt   DateTime  @default(now()) @map("started_at")
  completedAt DateTime? @map("completed_at")

  @@index([jobName])
  @@map("scheduled_job_runs")
}

// Database backup metadata
model DatabaseBackup {
  id        String   @id @default(uuid())
  filename  String
  sizeBytes Int      @map("size_bytes")
  path      String
  createdAt DateTime @default(now()) @map("created_at")
  expiresAt DateTime @map("expires_at")

  @@map("database_backups")
}

// Client task submission requests
model TaskSubmission {
  id          String    @id @default(uuid())
  clientId    String    @map("client_id")
  projectId   String?   @map("project_id")
  title       String
  description String?
  priority    String?
  submittedBy String    @map("submitted_by")
  status      String    @default("pending")
  taskId      String?   @unique @map("task_id")
  reviewedBy  String?   @map("reviewed_by")
  reviewedAt  DateTime? @map("reviewed_at")
  createdAt   DateTime  @default(now()) @map("created_at")

  client  Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  project Project? @relation(fields: [projectId], references: [id], onDelete: SetNull)
  task    Task?    @relation(fields: [taskId], references: [id], onDelete: SetNull)

  @@index([clientId])
  @@index([status])
  @@index([reviewedBy])
  @@index([submittedBy])
  @@map("task_submissions")
}

// Global app settings (theme, etc.)
model AppSettings {
  id             String   @id @default("default")
  theme          Json     @default("{}")
  emailTemplates Json     @default("{}") @map("email_templates")
  updatedAt      DateTime @updatedAt @map("updated_at")
  updatedBy      String?  @map("updated_by")

  @@map("app_settings")
}

// User guide/walkthrough completion tracking
model GuideCompletion {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  guideId     String   @map("guide_id")
  completedAt DateTime @default(now()) @map("completed_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, guideId])
  @@index([userId])
  @@map("guide_completions")
}

// Internal chat system
model Chat {
  id        String   @id @default(uuid())
  name      String? // For group chats
  isGroup   Boolean  @default(false) @map("is_group")
  creatorId String   @map("creator_id")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  creator          User                 @relation("ChatCreator", fields: [creatorId], references: [id])
  participants     ChatParticipant[]
  messages         ChatMessage[]
  telegramMessages TelegramMessageMap[]

  @@map("chats")
}

model ChatParticipant {
  id         String    @id @default(uuid())
  chatId     String    @map("chat_id")
  userId     String    @map("user_id")
  joinedAt   DateTime  @default(now()) @map("joined_at")
  lastReadAt DateTime? @map("last_read_at")

  chat Chat @relation(fields: [chatId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([chatId, userId])
  @@index([userId])
  @@map("chat_participants")
}

model ChatMessage {
  id        String   @id @default(uuid())
  chatId    String   @map("chat_id")
  senderId  String   @map("sender_id")
  content   String
  createdAt DateTime @default(now()) @map("created_at")

  chat         Chat              @relation(fields: [chatId], references: [id], onDelete: Cascade)
  sender       User              @relation(fields: [senderId], references: [id])
  attachments  ChatAttachment[]
  readReceipts ChatReadReceipt[]
  reactions    MessageReaction[]

  @@index([chatId, createdAt])
  @@map("chat_messages")
}

model ChatAttachment {
  id         String   @id @default(uuid())
  messageId  String   @map("message_id")
  fileName   String   @map("file_name")
  fileSize   Int      @map("file_size")
  fileType   String   @map("file_type")
  storageKey String   @map("storage_key")
  createdAt  DateTime @default(now()) @map("created_at")

  message ChatMessage @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@map("chat_attachments")
}

model ChatReadReceipt {
  id        String   @id @default(uuid())
  messageId String   @map("message_id")
  userId    String   @map("user_id")
  readAt    DateTime @default(now()) @map("read_at")

  message ChatMessage @relation(fields: [messageId], references: [id], onDelete: Cascade)
  user    User        @relation(fields: [userId], references: [id])

  @@unique([messageId, userId])
  @@map("chat_read_receipts")
}

// Track Telegram messages for reply functionality
model TelegramMessageMap {
  id                String   @id @default(uuid())
  telegramMessageId String   @unique @map("telegram_message_id")
  taskId            String?  @map("task_id")
  chatId            String?  @map("chat_id")
  recipientId       String   @map("recipient_id")
  replyToUserId     String   @map("reply_to_user_id")
  createdAt         DateTime @default(now()) @map("created_at")

  task        Task? @relation(fields: [taskId], references: [id], onDelete: Cascade)
  chat        Chat? @relation(fields: [chatId], references: [id], onDelete: Cascade)
  recipient   User  @relation("TelegramRecipient", fields: [recipientId], references: [id], onDelete: Cascade)
  replyToUser User  @relation("TelegramReplyTo", fields: [replyToUserId], references: [id], onDelete: Cascade)

  @@index([taskId])
  @@index([chatId])
  @@index([recipientId])
  @@map("telegram_message_map")
}

// Web Push subscriptions for PWA notifications
model PushSubscription {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  endpoint  String   @unique
  p256dh    String   // Public key for encryption
  auth      String   // Auth secret
  userAgent String?  @map("user_agent")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("push_subscriptions")
}

model TaskWatcher {
  id        String   @id @default(uuid())
  taskId    String   @map("task_id")
  userId    String   @map("user_id")
  muted     Boolean  @default(false)
  createdAt DateTime @default(now()) @map("created_at")

  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([taskId, userId])
  @@index([taskId])
  @@index([userId])
  @@map("task_watchers")
}

// ==========================================
// SEO Intelligence Module
// ==========================================

model SeoSettings {
  id              String   @id @default(uuid())
  enabled         Boolean  @default(false)
  runDayOfMonth   Int      @default(1) @map("run_day_of_month")
  telegramChatId  String?  @map("telegram_chat_id")
  driveFolderId   String?  @map("drive_folder_id")
  sopFolderId     String?  @map("sop_folder_id")
  tokenBudget     Int      @default(100000) @map("token_budget")
  retentionMonths Int      @default(6) @map("retention_months")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  @@map("seo_settings")
}

model SeoSource {
  id            String     @id @default(uuid())
  name          String
  url           String
  tier          SourceTier @default(tier_3)
  category      String     @default("general")
  fetchMethod   String     @default("rss") @map("fetch_method")
  fetchConfig   Json       @default("{}") @map("fetch_config")
  active        Boolean    @default(true)
  lastFetchedAt DateTime?  @map("last_fetched_at")
  createdAt     DateTime   @default(now()) @map("created_at")
  updatedAt     DateTime   @updatedAt @map("updated_at")

  fetchResults SeoFetchResult[]

  @@map("seo_sources")
}

model SeoDigest {
  id                       String          @id @default(uuid())
  period                   String
  status                   SeoDigestStatus @default(pending)
  sourcesFetched           Int             @default(0) @map("sources_fetched")
  recommendationsGenerated Int             @default(0) @map("recommendations_generated")
  taskDraftsCreated        Int             @default(0) @map("task_drafts_created")
  sopDraftsCreated         Int             @default(0) @map("sop_drafts_created")
  googleDocUrl             String?         @map("google_doc_url")
  errorMessage             String?         @map("error_message")
  startedAt                DateTime        @default(now()) @map("started_at")
  completedAt              DateTime?       @map("completed_at")
  createdAt                DateTime        @default(now()) @map("created_at")
  updatedAt                DateTime        @updatedAt @map("updated_at")

  fetchResults    SeoFetchResult[]
  recommendations SeoRecommendation[]
  taskDrafts      SeoTaskDraft[]
  sopDrafts       SeoSopDraft[]
  clientInsights  SeoClientInsight[]

  @@map("seo_digests")
}

model SeoFetchResult {
  id          String   @id @default(uuid())
  digestId    String   @map("digest_id")
  sourceId    String   @map("source_id")
  url         String
  title       String
  content     String
  contentHash String   @map("content_hash")
  publishedAt DateTime? @map("published_at")
  fetchedAt   DateTime @default(now()) @map("fetched_at")
  createdAt   DateTime @default(now()) @map("created_at")

  digest   SeoDigest  @relation(fields: [digestId], references: [id], onDelete: Cascade)
  source   SeoSource  @relation(fields: [sourceId], references: [id], onDelete: Cascade)
  citations SeoRecommendationCitation[]

  @@index([digestId])
  @@index([sourceId])
  @@index([contentHash])
  @@map("seo_fetch_results")
}

model SeoRecommendation {
  id          String                   @id @default(uuid())
  digestId    String                   @map("digest_id")
  category    String
  title       String
  summary     String
  details     String
  impact      String                   @default("medium")
  confidence  String                   @default("medium")
  status      SeoRecommendationStatus  @default(draft)
  sourceCount Int                      @default(1) @map("source_count")
  createdAt   DateTime                 @default(now()) @map("created_at")

  digest     SeoDigest                  @relation(fields: [digestId], references: [id], onDelete: Cascade)
  citations  SeoRecommendationCitation[]
  taskDrafts SeoTaskDraft[]
  sopDrafts  SeoSopDraft[]

  @@index([digestId])
  @@index([category])
  @@map("seo_recommendations")
}

model SeoRecommendationCitation {
  id               String   @id @default(uuid())
  recommendationId String   @map("recommendation_id")
  fetchResultId    String   @map("fetch_result_id")
  sourceUrl        String   @map("source_url")
  sourceName       String   @map("source_name")
  excerpt          String
  createdAt        DateTime @default(now()) @map("created_at")

  recommendation SeoRecommendation @relation(fields: [recommendationId], references: [id], onDelete: Cascade)
  fetchResult    SeoFetchResult    @relation(fields: [fetchResultId], references: [id], onDelete: Cascade)

  @@index([recommendationId])
  @@index([fetchResultId])
  @@map("seo_recommendation_citations")
}

model SeoTaskDraft {
  id                 String             @id @default(uuid())
  digestId           String             @map("digest_id")
  recommendationId   String?            @map("recommendation_id")
  title              String
  description        String
  suggestedProjectId String?            @map("suggested_project_id")
  suggestedPriority  String             @default("medium") @map("suggested_priority")
  suggestedDueInDays Int                @default(7) @map("suggested_due_in_days")
  status             SeoTaskDraftStatus @default(pending)
  taskId             String?            @unique @map("task_id")
  reviewedAt         DateTime?          @map("reviewed_at")
  createdAt          DateTime           @default(now()) @map("created_at")

  digest         SeoDigest          @relation(fields: [digestId], references: [id], onDelete: Cascade)
  recommendation SeoRecommendation? @relation(fields: [recommendationId], references: [id], onDelete: SetNull)
  task           Task?              @relation(fields: [taskId], references: [id], onDelete: SetNull)

  @@index([digestId])
  @@index([status])
  @@map("seo_task_drafts")
}

model SeoSopDraft {
  id               String    @id @default(uuid())
  digestId         String    @map("digest_id")
  recommendationId String?   @map("recommendation_id")
  templateSetId    String?   @map("template_set_id")
  sopDocId         String    @map("sop_doc_id")
  sopTitle         String    @map("sop_title")
  description      String
  draftType        String    @default("update") @map("draft_type")
  beforeContent    String    @map("before_content")
  afterContent     String    @map("after_content")
  status           String    @default("pending")
  appliedAt        DateTime? @map("applied_at")
  createdAt        DateTime  @default(now()) @map("created_at")

  digest         SeoDigest          @relation(fields: [digestId], references: [id], onDelete: Cascade)
  recommendation SeoRecommendation? @relation(fields: [recommendationId], references: [id], onDelete: SetNull)
  templateSet    TemplateSet?       @relation(fields: [templateSetId], references: [id], onDelete: SetNull)

  @@index([digestId])
  @@map("seo_sop_drafts")
}

model SeoClientInsight {
  id         String   @id @default(uuid())
  digestId   String   @map("digest_id")
  clientId   String   @map("client_id")
  dataSource String   @map("data_source")
  metrics    Json     @default("{}")
  period     String
  createdAt  DateTime @default(now()) @map("created_at")

  digest SeoDigest @relation(fields: [digestId], references: [id], onDelete: Cascade)
  client Client    @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([digestId])
  @@index([clientId])
  @@map("seo_client_insights")
}
